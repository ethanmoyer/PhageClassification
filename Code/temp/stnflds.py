#!/usr/bin/env python  

"""
Log which weather fields stations have
"""

import os
import re
import sys
import random
import datetime as dt
import traceback
from collections import OrderedDict
from multiprocessing import Pool, cpu_count
from subprocess import Popen, PIPE

STN_LOG = "static/stn_flds.txt"
header = ",".join(['ID','HR','MN','DIR','SPD','GUS','CLG','SKC','L','M','H','VSB','MW1','MW2','MW3','MW4','AW1','AW2','AW3','AW4','W',
          'TEMP','DEWP','SLP','ALT','STP','MAX','MIN','PCP01','PCP06','PCP24','PCPXX','SD']) + "\n"
if not os.path.exists(STN_LOG):
    with open(STN_LOG, 'w') as f:
        f.write(header)

# US stations
def datestr_to_dt(datestr):
    return dt.date(*map(int, [datestr[:4], datestr[4:6], datestr[6:8]]))

def parse_stn_line(line):
    try:
        return dict(usafid_wban='-'.join([line[0:6], line[7:12]]), name=line[13:43], state=line[49:51], lat=float(line[58:64])/1000.,
                    lon=float(line[65:72])/1000., sd=datestr_to_dt(line[83:91]), ed=datestr_to_dt(line[92:100]),)
    except:
        return None

def stn_covg(path='static/ISH-HISTORY.TXT'):
    stns = {'-'.join([line[0:6], line[7:12]]): parse_stn_line(line) for line in map(lambda x: x.strip(), open(path).readlines())}
    return {key: stns[key] for key in stns if stns[key]}

def get_stn_year(_id, us_stns):
    sd = us_stns[_id]['sd']
    ed = us_stns[_id]['ed']
    yrs = range(sd.year, ed.year + 1)
    try:
        return yrs[-3]              # likely to be representative, if exists
    except:
        return random.choice(yrs)   # faliing that, random choice

def log_station((_id, log_stns, us_stns)):
    # only continue if we have not logged this station already
    if _id in log_stns:
        return ''
    try:
        yr = get_stn_year(_id, us_stns)
        url = 'ftp://ftp.ncdc.noaa.gov/pub/data/noaa/{0}/{1}-{0}.gz'.format(yr, _id)
        print '\nretrieving stn=%s  yr=%s ... \n' % (_id, str(yr))
        p1 = Popen(["curl", url], stdout=PIPE)
        p2 = Popen(["gunzip"], stdin=p1.stdout, stdout=PIPE)
        p3 = Popen(['java', '-classpath', 'static', 'ishJava'], stdin=p2.stdout, stdout=PIPE)
        data = p3.communicate()[0].split("\n")[1:-1]

        flds = (
            ['HR',      [21,23]], ['MN',      [23,25]], ['DIR',     [26,29]], ['SPD',     [30,33]], ['GUS',   [34,37]], 
            ['CLG',     [38,41]], ['SKC',     [42,45]], ['L',       [46,47]], ['M',       [48,49]], ['H',     [50,51]], 
            ['VSB',     [52,56]], ['MW1',     [57,59]], ['MW2',     [60,62]], ['MW3',     [63,65]], ['MW4',   [66,68]], 
            ['AW1',     [69,71]], ['AW2',     [72,74]], ['AW3',     [75,77]], ['AW4',     [78,80]], ['W',     [81,82]], 
            ['TEMP',    [83,87]], ['DEWP',    [88,92]], ['SLP',     [93,99]], ['ALT',   [100,105]], ['STP', [106,112]], 
            ['MAX',   [113,116]], ['MIN',   [117,120]], ['PCP01', [121,126]], ['PCP06', [127,132]], 
            ['PCP24', [133,138]], ['PCPXX', [139,144]], ['SD',    [145,147]], 
            )

        def get_col(data, fld):
            return [dataline[fld[1][0]:fld[1][1]] for dataline in data]
    
        def fld_test(col):
            return any(['*' not in x for x in col])
    
        line = ",".join([_id] + map(str, [1 if fld_test(get_col(data, fld)) else 0 for fld in flds])) + "\n"
        return line if '1' in "".join(line.split(',')[1:]) else ''
    except:
        traceback.print_exc()
        return ''
    
def main(n):
    # all stns in the US
    us_stns = stn_covg()
    # stns already tested, mapped by USAFID_WBAN
    log_stns = {line.split(",")[0]: line for line in open(STN_LOG).readlines()[1:]}   # skip header
    # station ids not logged yet
    unk_stns = [stn for stn in us_stns if stn not in log_stns]
    print "\nlen(unk_stns):", len(unk_stns), '\n'

    # stations that appear to fail for unexpected reasons
    fail_stns = ['692704-99999', '700866-99999', '999999-93725', '727345-99999', '749173-99999', '720399-99999', '722047-99999', '724959-99999',
                 '724995-99999', '725048-99999', '999999-94701', '999999-94707', '999999-94706', '999999-14814', '745200-23176', '720529-99999',
                 '999999-93708', '726397-99999', '722076-99999', '722184-99999', '722035-99999', '999999-23191', '999999-23193', '725820-99999',
                 '692494-99999', '999999-24281', '722075-99999', '742065-99999', '999999-13875', '999999-13872', '999999-93860', '999999-93869',
                 '999999-23173', '726080-14608', '725400-99999', '992460-99999', '691684-99999', '690924-99999', '727377-99999', '744600-99999',
                 '725900-99999', '999999-24003', '911680-99999', '722657-23041', '999999-93211', '722239-99999', '746140-23141', '690290-99999',
                 '723303-93862', '999999-93847', '996000-99999', '722167-99999', '999999-93022', '999999-14874', '999999-24026', '745054-99999',
                 '746960-99999', '743925-99999', '722518-99999', '999999-12806', '999999-93002', '999999-23075', '999999-23073', '701620-26508',
                 '700869-99999', '725532-14942', '726340-99999', '999999-25302', '999999-14934', '999999-14939', '746950-99999', '999999-93802',
                 '722888-99999', '725643-99999', '727854-99999', '702031-26620', '692504-99999', '999999-24068', '999999-25334', '999999-04203',
                 '999999-04202', '727446-99999', '724670-03017', '745097-99999', '704090-45709', '742075-99999', '726036-99999', '692304-99999',
                 '999999-14888', '992680-99999', '999999-14763', '999999-04220', '722145-99999', '992990-99999', '723274-99999', '999999-14971',
                 '747756-99999', '695354-99999', '726035-99999', '722240-99999', '701749-99999', '722290-03881', '999999-63830', '999999-24241',
                 '695364-99999', '999999-13703', '999999-14959', '724678-99999', '724947-99999', '722003-99999', '692464-99999', '999999-94058',
                 '911840-99999', '999999-14721', '994320-99999', '698114-99999', '724958-99999', '999999-13892', '725788-99999', '999999-04854',
                 '994510-99999', '999999-93993', '999999-93991', '723750-99999', '999999-94071', '999999-94072', '999999-12938', '742005-99999',
                 '999999-12930', '999999-12934', '722072-99999', '992800-99999', '744650-99999', '999999-03871', '999999-03872', '722068-99999',
                 '725824-99999', '999999-14884', '999999-14885', '999999-14887', '999999-14881', '999999-14882', '999999-14883', '690260-99999',
                 '912870-99999', '996370-99999', '999999-03815', '999999-53875', '726388-99999', '702696-99999', '911803-99999', '999999-53124',
                 '999999-53125', '999999-04741', '999999-24129', '999999-24122', '999999-93954', '999999-93958', '700630-27403', '990170-99999',
                 '999999-23106', '999999-23103', '999999-53854', '999999-13784', '999999-13780', '911976-99999', '702700-99999', '704896-25625',
                 '999999-24108', '999999-94756', '999999-94753', '999999-93972', '691804-99999', '999999-23128', '703053-99999', '999999-94176',
                 '992550-99999', '999999-94771', '999999-94777', '747685-99999', '999999-93916', '994380-99999', '722327-99999', '702673-99999',
                 '724935-99999', '725786-24151', '726576-14928', '722088-99999', '727925-99999', '726320-99999', '999999-94718', '999999-94712',
                 '999999-27503', '999999-93930', '999999-93936', '725243-99999', '911580-99999', '998175-99999', '722346-99999', '727410-99999',
                 '701046-26418', '722094-99999', '724939-99999', '999999-23166', '745165-99999', '999999-93896', '999999-93892', '999999-93893',
                 '999999-93891', '720581-99999', '726950-99999', '997364-99999', '999999-94734', '724943-99999', '992170-99999', '692374-99999',
                 '725346-94866', '999999-93877', '999999-14611', '992690-99999', '723410-99999', '692364-99999', '996360-99999', '720000-99999',
                 '999999-24012', '912853-21504', '992560-99999', '727500-99999', '702180-99999', '999999-14987', '999999-14983', '999999-04115',
                 '999999-93853', '999999-93851', '999999-93854', '999999-93855', '999999-93858', '725753-99999', '749088-99999', '999999-92812',
                 '992870-99999', '999999-93031', '722093-99999', '999999-14861', '992330-99999', '999999-23083', '999999-23080', '992970-99999',
                 '997357-99999', '722019-99999', '999999-93852', '725646-99999', '999999-93856', '745055-99999', '725860-99999', '745096-99999',
                 '999999-93016', '703640-99999', '999999-24234', '999999-24055', '999999-24058', '999999-03729', '912810-99999', '725255-99999',
                 '724043-99999', '996310-99999', '722985-99999', '999999-93810', '749068-99999', '999999-24075', '722165-13815', '999999-12859',
                 '992520-99999', '997701-99999', '999999-13801', '702980-26445', '996990-99999', '999999-13779', '999999-13778', '725397-99999',
                 '725580-99999', '745095-99999', '992830-99999', '722059-99999', '692884-99999', '999999-24274', '723490-99999', '999999-53881',
                 '999999-53882', '999999-93849', '999999-93848', '999999-04124', '724630-99999', '722031-99999', '999999-22522', '722079-99999',
                 '691474-99999', '994440-99999', '992250-99999', '695414-99999', '702674-99999', '692584-99999', '999999-63820', '992670-99999',
                 '747340-99999', '999999-13735', '999999-14968', '999999-14961', '999999-14967', '999999-03046', '749167-99999', '999999-14831',
                 '720021-99999', '703850-99999', '722399-99999', '723305-99999', '996810-99999', '999999-04861', '745065-99999', '999999-24199',
                 '726403-99999', '722041-99999', '725947-99999', '999999-93981', '724844-99999', '725948-99999', '999999-63860', '746943-99999',
                 '697534-99999', '999999-24175', '992390-99999', '999999-93145', '999999-93140', '999999-93142', '999999-26442', '725023-99999',
                 '726358-99999', '745039-99999', '703605-99999', '999999-93915', '725283-99999', '692644-99999', '703600-99999', '999999-94781',
                 '999999-14893', '999999-14892', '703715-99999', '999999-93946', '722356-99999', '726058-99999', '723654-99999', '690500-99999',
                 '696134-99999', '999999-12940', '999999-12945', '690300-99999', '999999-14796', '725530-99999', '911660-99999', '999999-26422',
                 '725094-99999', '911690-99999', '999999-53867', '999999-94910', '690964-99999', '999999-53134', '999999-53133', '724836-99999',
                 '723245-99999', '722101-99999', '722986-99999', '740184-99999', '690584-99999', '722005-99999', '724950-23250', '999999-93963',
                 '999999-93964', '724600-99999', '727984-99999', '996590-99999', '745045-99999', '727979-99999', '999999-93982', '999999-24056',
                 '999999-94105', '999999-94104', '999999-94103', '992570-99999', '727996-99999', '691404-99999', '911550-99999', '727554-99999',
                 '700300-27508', '992150-99999', '727416-99999', '992510-99999', '999999-94768', '999999-94760', '722394-99999', '999999-93922',
                 '999999-93923', '999999-93928',]

    # filter out fail stations
    unk_stns = [stn for stn in unk_stns if stn not in fail_stns]
    
    if len(unk_stns) > 0:
        # stns we will log (randomly selected)
        t = range(len(unk_stns))
        random.shuffle(t) 
        stn_ids = [unk_stns[t[i]] for i in range(min(n, len(unk_stns)))]
        
        # make requests in parallel
        nprocs = max(1, cpu_count() - 1)
        print "making requests in parallel on < %s > processors" % str(nprocs)
        pool = Pool(processes=nprocs)
        result = pool.map_async(log_station, [(_id, log_stns, us_stns) for _id in stn_ids])
        log_lines = result.get()

        # write log_lines to STN_LOG
        with open(STN_LOG, "a") as f:
            f.writelines(log_lines)
    
if __name__ == "__main__":
    if sys.argv[1:]:
        if re.search("^\d{6}-\d{5}$", sys.argv[1]):
            log_station(re.search("^\d{6}-\d{5}$", sys.argv[1]).group(0))
        else:
            # coerce first arg to an int, and randomly check that many unknown stations
            main(int(sys.argv[1]))
    else:
        # by default, log 10 random US stations
        main(10)
